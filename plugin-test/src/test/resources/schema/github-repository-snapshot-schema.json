{
  "$schema": "https://json-schema.org/draft/2019-09/schema",
  "title": "Repository Snapshot",
  "description": "Validation schema for a well-formed repository build-time dependency snapshot submission request",
  "type": "object",
  "links": [
    {
      "title": "Create Repository Snapshot",
      "href": "/repositories/{repository_id}/snapshots",
      "method": "POST",
      "rel": "create-snapshot",
      "schema": {
        "title": "Create a new build snapshot",
        "properties": {
          "version": {
            "$ref": "#/definitions/version"
          },
          "job": {
            "$ref": "#/definitions/job"
          },
          "sha": {
            "$ref": "#/definitions/sha"
          },
          "ref": {
            "$ref": "#/definitions/ref"
          },
          "detector": {
            "$ref": "#/definitions/detector"
          },
          "metadata": {
            "$ref": "#/definitions/metadata"
          },
          "manifests": {
            "$ref": "#/definitions/manifests"
          }
        },
        "scanned": {
          "$ref": "#/definitions/scanned"
        },
        "type": "object",
        "required": [
          "version",
          "ref",
          "sha",
          "job",
          "scanned"
        ]
      }
    }
  ],
  "definitions": {
    "version": {
      "description": "The version of the repository snapshot submission.",
      "type": "integer"
    },
    "job": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "The external ID of the job.",
          "example": "5622a2b0-63f6-4732-8c34-a1ab27e102a11"
        },
        "name": {
          "type": "string",
          "description": "The name of the job.",
          "example": "build"
        },
        "html_url": {
          "type": "string",
          "description": "The url for the job.",
          "example": "http://example.com/build"
        }
      },
      "required": [
        "id",
        "name"
      ],
      "additionalProperties": false
    },
    "sha": {
      "description": "The commit SHA associated with this build snapshot.",
      "type": "string",
      "example": "ddc951f4b1293222421f2c8df679786153acf689",
      "minLength": 40
    },
    "ref": {
      "description": "The repository branch that triggered this snapshot.",
      "type": "string",
      "pattern": "^refs/",
      "example": "refs/heads/main"
    },
    "detector": {
      "type": "object",
      "description": "A description of the detector used.",
      "properties": {
        "name": {
          "type": "string",
          "description": "The name of the detector used.",
          "example": "docker buildtime detector"
        },
        "version": {
          "type": "string",
          "description": "The version of the detector used.",
          "example": "1.0.0"
        },
        "url": {
          "type": "string",
          "description": "The url of the detector used.",
          "example": "http://example.com/docker-buildtimer-detector"
        }
      },
      "required": [
        "name",
        "version",
        "url"
      ],
      "additionalProperties": false
    },
    "metadata": {
      "type": "object",
      "description": "User-defined metadata to store domain-specific information limited to 8 keys with scalar values.",
      "maxProperties": 8,
      "additionalProperties": {
        "type": [
          "string",
          "number",
          "boolean",
          "null"
        ]
      }
    },
    "dependency_graph": {
      "type": "object",
      "description": "Dependency Graph generated by a specific manifest.",
      "additionalProperties": {
        "$ref": "#/definitions/dependency"
      }
    },
    "dependency": {
      "type": "object",
      "description": "A single package dependency.",
      "properties": {
        "purl": {
          "type": "string",
          "description": "Package-url (PURL) of dependency",
          "example": "pkg:/npm/%40actions/http-client@1.0.11",
          "pattern": "^pkg"
        },
        "metadata": {
          "$ref": "#/definitions/metadata"
        },
        "relationship": {
          "type": "string",
          "description": "A notation of whether a dependency is requested directly by this manifest, or is a dependency of another dependency.",
          "example": "direct",
          "enum": [
            "direct",
            "indirect"
          ]
        },
        "scope": {
          "type": "string",
          "description": "A notation of whether the dependency is required for the primary build artifact (runtime), or is only used for development. Future versions of this specification may allow for more granular scopes.",
          "example": "runtime",
          "enum": [
            "runtime",
            "development"
          ]
        },
        "dependencies": {
          "type": "array",
          "description": "Array of package-url (PURLs) of direct child dependencies.",
          "example": [
            "@actions/http-client"
          ],
          "items": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false
    },
    "manifests": {
      "type": "object",
      "description": "A collection of package manifests",
      "additionalProperties": {
        "$ref": "#/definitions/manifest"
      }
    },
    "manifest": {
      "type": "object",
      "description": "A collection of related dependencies declared in a file or representing a logical group of dependencies.",
      "properties": {
        "name": {
          "type": "string",
          "description": "The name of the manifest.",
          "example": "package-lock.json"
        },
        "file": {
          "type": "object",
          "properties": {
            "source_location": {
              "type": "string",
              "description": "The path of the manifest file, relative to the root of the Git repository.",
              "example": "/src/build/package-lock.json"
            }
          },
          "additionalProperties": false
        },
        "metadata": {
          "$ref": "#/definitions/metadata"
        },
        "resolved": {
          "$ref": "#/definitions/dependency_graph"
        }
      },
      "required": [
        "name"
      ],
      "additionalProperties": false
    },
    "scanned": {
      "type": "string",
      "format": "date-time",
      "description": "The time at which the snapshot was scanned.",
      "example": "2020-06-13T14:52:50-05:00"
    }
  },
  "properties": {
    "version": {
      "$ref": "#/definitions/version"
    },
    "job": {
      "$ref": "#/definitions/job"
    },
    "sha": {
      "$ref": "#/definitions/sha"
    },
    "ref": {
      "$ref": "#/definitions/ref"
    },
    "detector": {
      "$ref": "#/definitions/detector"
    },
    "metadata": {
      "$ref": "#/definitions/metadata"
    },
    "manifests": {
      "$ref": "#/definitions/manifests"
    },
    "scanned": {
      "$ref": "#/definitions/scanned"
    }
  },
  "additionalProperties": false
}
